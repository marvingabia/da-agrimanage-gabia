<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AgriSystem</title>
    <!-- Force browser to reload - no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/agriculture-dashboard.css" rel="stylesheet">
    <link href="/css/premium-sections.css" rel="stylesheet">
    <link href="/css/mobile-enhancements.css" rel="stylesheet">
    <link href="/css/mobile-responsive.css" rel="stylesheet">
    <link href="/css/data-analytics.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .badge-pulse {
            animation: pulse 0.5s ease-in-out 3;
            background-color: #dc3545 !important;
        }
    </style>
</head>
<body data-user-role="{{user.role}}"
    <!-- Mobile Hamburger Menu -->
    <button class="hamburger-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar vh-100">
                <div class="position-sticky pt-3">
                    <h4 class="text-white px-3 mb-4">
                        <i class="fas fa-leaf me-2"></i>AgriSystem
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="#" onclick="showSection('dashboard')" id="nav-dashboard">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </a>
                        </li>
         
               
                        <!-- Farmer Menu -->
                        {{#if (eq user.role 'farmer')}}
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('insurance')" id="nav-insurance">
                                <i class="fas fa-shield-alt me-2"></i>Insurance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('damage-reports')" id="nav-damage-reports">
                                <i class="fas fa-exclamation-triangle me-2"></i>Damage Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('claims')" id="nav-claims">
                                <i class="fas fa-hand-holding-usd me-2"></i>Claims
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('request-letters')" id="nav-request-letters">
                                <i class="fas fa-envelope me-2"></i>Request Letters
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('announcements')" id="nav-announcements">
                                <i class="fas fa-bullhorn me-2"></i>Announcements
                            </a>
                        </li>
                        {{/if}}
                        
                        <!-- Staff Menu -->
                        {{#if (eq user.role 'staff')}}
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('farmers-list')" id="nav-farmers-list">
                                <i class="fas fa-users me-2"></i>Farmers
                                <span class="badge bg-primary rounded-pill float-end" id="sidebar-farmers-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('insurance')" id="nav-insurance">
                                <i class="fas fa-shield-alt me-2"></i>Insurance
                                <span class="badge bg-info rounded-pill float-end" id="sidebar-insurance-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('damage-reports')" id="nav-damage-reports">
                                <i class="fas fa-exclamation-triangle me-2"></i>Damage Reports
                                <span class="badge bg-warning rounded-pill float-end" id="sidebar-reports-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('claims')" id="nav-claims">
                                <i class="fas fa-hand-holding-usd me-2"></i>Claims
                                <span class="badge bg-success rounded-pill float-end" id="sidebar-claims-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('request-letters')" id="nav-request-letters">
                                <i class="fas fa-envelope me-2"></i>Request Letters
                                <span class="badge bg-danger rounded-pill float-end" id="sidebar-requests-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('inventory')" id="nav-inventory">
                                <i class="fas fa-seedling me-2"></i>Crop Management
                                <span class="badge bg-secondary rounded-pill float-end" id="sidebar-inventory-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('announcements')" id="nav-announcements">
                                <i class="fas fa-bullhorn me-2"></i>Announcements
                                <span class="badge bg-light text-dark rounded-pill float-end" id="sidebar-announcements-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('data-analytics')" id="nav-data-analytics">
                                <i class="fas fa-chart-line me-2"></i>Data Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('send-notifications')" id="nav-send-notifications">
                                <i class="fas fa-paper-plane me-2"></i>Send Notifications
                            </a>
                        </li>
                        {{/if}}
                        
                        <!-- Admin Menu -->
                        {{#if (eq user.role 'admin')}}
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('staff-management')" id="nav-staff-management">
                                <i class="fas fa-user-tie me-2"></i>Staff Management
                                <span class="badge bg-primary rounded-pill float-end" id="sidebar-staff-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('farmers-list')" id="nav-farmers-list">
                                <i class="fas fa-users me-2"></i>Farmers
                                <span class="badge bg-primary rounded-pill float-end" id="sidebar-farmers-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('insurance')" id="nav-insurance">
                                <i class="fas fa-shield-alt me-2"></i>Insurance
                                <span class="badge bg-info rounded-pill float-end" id="sidebar-insurance-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('damage-reports')" id="nav-damage-reports">
                                <i class="fas fa-exclamation-triangle me-2"></i>Damage Reports
                                <span class="badge bg-warning rounded-pill float-end" id="sidebar-reports-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('claims')" id="nav-claims">
                                <i class="fas fa-hand-holding-usd me-2"></i>Claims
                                <span class="badge bg-success rounded-pill float-end" id="sidebar-claims-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('request-letters')" id="nav-request-letters">
                                <i class="fas fa-envelope me-2"></i>Request Letters
                                <span class="badge bg-danger rounded-pill float-end" id="sidebar-requests-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('inventory')" id="nav-inventory">
                                <i class="fas fa-seedling me-2"></i>Crop Management
                                <span class="badge bg-secondary rounded-pill float-end" id="sidebar-inventory-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="showSection('announcements')" id="nav-announcements">
                                <i class="fas fa-bullhorn me-2"></i>Announcements
                                <span class="badge bg-light text-dark rounded-pill float-end" id="sidebar-announcements-count">0</span>
                            </a>
                        </li>
                        {{/if}}
                        
                        <!-- Notifications -->
                        <li class="nav-item mt-4">
                            <a class="nav-link text-white" href="#" onclick="toggleNotifications()" id="nav-notifications">
                                <i class="fas fa-bell me-2"></i>Notifications
                                <span class="badge bg-danger rounded-pill float-end pulse" id="notification-count" style="display:none;">0</span>
                            </a>
                        </li>
                        
                        <!-- Settings & Logout -->
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/settings">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Notification Overlay -->
            <div id="notification-overlay" class="notification-overlay" onclick="toggleNotifications()"></div>
            
            <!-- Notification Panel -->
            <div id="notification-panel" class="notification-panel">
                <div class="notification-header">
                    <h5><i class="fas fa-bell me-2"></i>Notifications</h5>
                    <button class="btn-close-panel" onclick="toggleNotifications()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-body" id="notification-list">
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>No new notifications</p>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Welcome, {{user.name}}</h1>
                    <div class="badge bg-primary text-uppercase">{{user.role}}</div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="row">
                        {{#if (eq user.role 'farmer')}}
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-shield-alt text-primary"></i> Insurance</h5>
                                    <p class="card-text display-6" id="insurance-count">0</p>
                                    <p class="text-muted">Applications</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-file-alt text-success"></i> Damage Reports</h5>
                                    <p class="card-text display-6" id="reports-count">0</p>
                                    <p class="text-muted">Submitted</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-envelope text-info"></i> Request Letters</h5>
                                    <p class="card-text display-6" id="requests-count">0</p>
                                    <p class="text-muted">Sent</p>
                                </div>
                            </div>
                        </div>
                        {{/if}}
                        
                        {{#if (eq user.role 'staff')}}
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-users text-primary"></i> Farmers</h5>
                                    <p class="card-text display-6" id="farmers-count">{{stats.totalFarmers}}</p>
                                    <p class="text-muted">Registered</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-shield-alt text-success"></i> Insurance</h5>
                                    <p class="card-text display-6" id="insurance-count">0</p>
                                    <p class="text-muted">Applications</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-file-alt text-warning"></i> Reports</h5>
                                    <p class="card-text display-6" id="reports-count">0</p>
                                    <p class="text-muted">Damage Reports</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-box text-info"></i> Inventory</h5>
                                    <p class="card-text display-6" id="inventory-count">{{stats.inventoryItems}}</p>
                                    <p class="text-muted">Items</p>
                                </div>
                            </div>
                        </div>
                        {{/if}}
                        
                        {{#if (eq user.role 'admin')}}
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-users text-primary"></i> Farmers</h5>
                                    <p class="card-text display-6" id="farmers-count">{{stats.totalFarmers}}</p>
                                    <p class="text-muted">Registered</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-user-tie text-success"></i> Staff</h5>
                                    <p class="card-text display-6" id="staff-count">{{stats.totalStaff}}</p>
                                    <p class="text-muted">Active Staff</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-clock text-warning"></i> Pending</h5>
                                    <p class="card-text display-6" id="pending-count">0</p>
                                    <p class="text-muted">Staff Approvals</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-bullhorn text-info"></i> Announcements</h5>
                                    <p class="card-text display-6" id="announcements-count">{{stats.activeAnnouncements}}</p>
                                    <p class="text-muted">Active</p>
                                </div>
                            </div>
                        </div>
                        {{/if}}
                    </div>
                </div>

                <!-- Insurance Section -->
                <div id="insurance-section" style="display:none;">
                    {{> insurance}}
                </div>
                
                <!-- Damage Reports Section -->
                <div id="damage-reports-section" style="display:none;">
                    {{> damage-reports}}
                </div>
                
                <!-- Claims Section -->
                <div id="claims-section" style="display:none;">
                    {{> claims}}
                </div>
                
                <!-- Request Letters Section -->
                <div id="request-letters-section" style="display:none;">
                    {{> request-letters}}
                </div>
                
                <!-- Inventory Section -->
                <div id="inventory-section" style="display:none;">
                    {{> inventory}}
                </div>
                
                <!-- Data Analytics Section -->
                <div id="data-analytics-section" style="display:none;">
                    {{> data-analytics}}
                </div>
                
                <!-- Send Notifications Section -->
                <div id="send-notifications-section" style="display:none;">
                    {{> send-notifications}}
                </div>
                
                <!-- Announcements Section -->
                <div id="announcements-section" style="display:none;">
                    {{> announcements}}
                </div>
                
                <!-- Farmers List Section -->
                <div id="farmers-list-section" style="display:none;">
                    {{> farmers-list}}
                </div>
                
                <!-- Staff Management Section -->
                <div id="staff-management-section" style="display:none;">
                    {{> staff-management}}
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/mobile-menu.js"></script>
    <script src="/js/auto-refresh-staff.js"></script>
    <script>
        // Global role check - prevent admin API calls for non-admin users
        const USER_ROLE = '{{user.role}}';
        console.log('?? User Role:', USER_ROLE);
        
        // Override any admin-only functions if user is not admin
        if (USER_ROLE !== 'admin') {
            console.log('?? Non-admin user detected - disabling admin functions');
            
            // Disable loadPendingStaff if it exists
            window.loadPendingStaff = function() {
                console.log('?? loadPendingStaff blocked - not admin');
                return Promise.resolve();
            };
            
            // Disable loadApprovedStaff if it exists
            window.loadApprovedStaff = function() {
                console.log('?? loadApprovedStaff blocked - not admin');
                return Promise.resolve();
            };
            
            // Disable loadStaffManagement if it exists
            window.loadStaffManagement = function() {
                console.log('?? loadStaffManagement blocked - not admin');
                return Promise.resolve();
            };
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
        
        // Mobile Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }
        
        // Close sidebar when clicking a nav link on mobile
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const navLink = document.getElementById('nav-' + section);
            if (navLink) navLink.classList.add('active');
            
            // Show dashboard section immediately (no loading needed)
            if (section === 'dashboard') {
                document.getElementById('dashboard-section').style.display = 'block';
                loadDashboardData();
                return;
            }
            
            // Show section immediately (partials are already loaded)
            const sectionDiv = document.getElementById(section + '-section');
            if (sectionDiv) {
                sectionDiv.style.display = 'block';
                
                // Call the appropriate load function for each section
                setTimeout(() => {
                    if (section === 'damage-reports' && typeof loadDamageReports === 'function') {
                        console.log('?? Loading damage reports...');
                        loadDamageReports();
                    } else if (section === 'insurance' && typeof loadInsurance === 'function') {
                        console.log('??? Loading insurance...');
                        loadInsurance();
                    } else if (section === 'claims' && typeof loadClaims === 'function') {
                        console.log('?? Loading claims...');
                        loadClaims();
                    } else if (section === 'request-letters' && typeof loadRequestLetters === 'function') {
                        console.log('?? Loading request letters...');
                        loadRequestLetters();
                    } else if (section === 'farmers-list' && typeof loadFarmers === 'function') {
                        console.log('????? Loading farmers...');
                        loadFarmers();
                    } else if (section === 'inventory') {
                        console.log('?? Loading inventory...');
                        console.log('?? window.loadInventory exists?', typeof window.loadInventory);
                        if (typeof window.loadInventory === 'function') {
                            window.loadInventory();
                        } else {
                            console.error('? window.loadInventory is not defined!');
                            // Try again after a delay
                            setTimeout(() => {
                                if (typeof window.loadInventory === 'function') {
                                    console.log('?? Retry: Loading inventory...');
                                    window.loadInventory();
                                } else {
                                    console.error('? Still not defined after retry');
                                }
                            }, 500);
                        }
                    } else if (section === 'announcements' && typeof loadAnnouncements === 'function') {
                        console.log('📢 Loading announcements...');
                        loadAnnouncements();
                    } else if (section === 'data-analytics' && typeof loadAnalytics === 'function') {
                        console.log('📊 Loading data analytics...');
                        loadAnalytics();
                    } else if (section === 'send-notifications') {
                        console.log('📧 Loading send notifications...');
                        // Load notification history for staff/admin only
                        const userRole = '{{user.role}}';
                        if ((userRole === 'staff' || userRole === 'admin') && typeof loadNotificationHistory === 'function') {
                            loadNotificationHistory();
                        }
                    } else if (section === 'staff-management' && typeof loadStaffManagement === 'function') {
                        console.log('?? Loading staff management...');
                        loadStaffManagement();
                    }
                }, 100);
            }
        }
        
        function loadDashboardData() {
            const userRole = '{{user.role}}';
            const userId = '{{user.id}}';
            
            console.log('?? Loading dashboard data for', userRole, userId);
            
            // Load insurance count
            fetch('/api/insurance')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const insuranceCount = userRole === 'farmer' 
                            ? data.insurance.filter(i => i.farmerId === userId).length
                            : data.insurance.length;
                        const insuranceEl = document.getElementById('insurance-count');
                        if (insuranceEl) {
                            insuranceEl.textContent = insuranceCount;
                            console.log('? Insurance count updated:', insuranceCount);
                        }
                    }
                })
                .catch(error => console.error('Error loading insurance:', error));
            
            // Load damage reports count
            fetch('/api/damage-reports')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const reportsCount = userRole === 'farmer'
                            ? data.damageReports.filter(r => r.farmerId === userId).length
                            : data.damageReports.length;
                        const reportsEl = document.getElementById('reports-count');
                        if (reportsEl) {
                            reportsEl.textContent = reportsCount;
                            console.log('? Damage reports count updated:', reportsCount);
                        }
                    }
                })
                .catch(error => console.error('Error loading reports:', error));
            
            // Load request letters count (for all roles)
            const requestEndpoint = userRole === 'farmer' ? '/api/farmer/request-letters' : '/api/staff/request-letters';
            fetch(requestEndpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.requests) {
                        const requestsCount = (data.requests || []).length;
                        const requestsEl = document.getElementById('requests-count');
                        if (requestsEl) {
                            requestsEl.textContent = requestsCount;
                            console.log('? Request letters count updated:', requestsCount);
                        }
                    }
                })
                .catch(error => console.error('Error loading requests:', error));
            
            // Load pending staff count (for admin)
            if (userRole === 'admin') {
                fetch('/api/admin/pending-staff')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const pendingEl = document.getElementById('pending-count');
                            if (pendingEl) {
                                pendingEl.textContent = data.pendingStaff.length;
                                console.log('? Pending staff count updated:', data.pendingStaff.length);
                            }
                        }
                    })
                    .catch(error => console.error('Error loading pending staff:', error));
            }
            
            // Load inventory count
            fetch('/api/inventory')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const inventoryEl = document.getElementById('inventory-count');
                        if (inventoryEl) {
                            inventoryEl.textContent = data.inventory.length;
                            console.log('? Inventory count updated:', data.inventory.length);
                        }
                    }
                })
                .catch(error => console.error('Error loading inventory:', error));
        }
        
        // Update sidebar counts from MySQL database
        function updateSidebarCounts() {
            const userRole = '{{user.role}}';
            
            console.log('?? Updating sidebar counts for role:', userRole);
            
            // Load farmers count
            if (userRole === 'staff' || userRole === 'admin') {
                fetch('/api/farmers')
                    .then(response => response.json())
                    .then(data => {
                        const count = data.farmers ? data.farmers.length : 0;
                        const el = document.getElementById('sidebar-farmers-count');
                        if (el) el.textContent = count;
                    })
                    .catch(error => console.error('Error loading farmers count:', error));
            }
            
            // Load staff count (admin only)
            if (userRole === 'admin') {
                console.log('?? Loading staff count (admin only)');
                fetch('/api/admin/all-staff')
                    .then(response => response.json())
                    .then(data => {
                        const count = data.staff ? data.staff.length : 0;
                        const el = document.getElementById('sidebar-staff-count');
                        if (el) el.textContent = count;
                    })
                    .catch(error => console.error('Error loading staff count:', error));
            } else {
                console.log('?? Skipping staff count (not admin)');
            }
            
            // Load insurance count
            fetch('/api/insurance')
                .then(response => response.json())
                .then(data => {
                    const count = data.insurance ? data.insurance.length : 0;
                    const el = document.getElementById('sidebar-insurance-count');
                    if (el) el.textContent = count;
                })
                .catch(error => console.error('Error loading insurance count:', error));
            
            // Load damage reports count
            fetch('/api/damage-reports')
                .then(response => response.json())
                .then(data => {
                    const count = data.damageReports ? data.damageReports.length : 0;
                    const el = document.getElementById('sidebar-reports-count');
                    if (el) el.textContent = count;
                })
                .catch(error => console.error('Error loading reports count:', error));
            
            // Load claims count
            fetch('/api/claims')
                .then(response => response.json())
                .then(data => {
                    const count = data.claims ? data.claims.length : 0;
                    const el = document.getElementById('sidebar-claims-count');
                    if (el) el.textContent = count;
                })
                .catch(error => console.error('Error loading claims count:', error));
            
            // Load request letters count
            const requestEndpoint = userRole === 'farmer' ? '/api/farmer/request-letters' : '/api/staff/request-letters';
            fetch(requestEndpoint)
                .then(response => response.json())
                .then(data => {
                    const count = data.requests ? data.requests.length : 0;
                    const el = document.getElementById('sidebar-requests-count');
                    if (el) el.textContent = count;
                })
                .catch(error => console.error('Error loading requests count:', error));
            
            // Load inventory count
            fetch('/api/inventory')
                .then(response => response.json())
                .then(data => {
                    const count = data.inventory ? data.inventory.length : 0;
                    const el = document.getElementById('sidebar-inventory-count');
                    if (el) el.textContent = count;
                })
                .catch(error => console.error('Error loading inventory count:', error));
            
            // Load announcements count
            fetch('/api/announcements')
                .then(response => response.json())
                .then(data => {
                    const count = data.announcements ? data.announcements.length : 0;
                    const el = document.getElementById('sidebar-announcements-count');
                    if (el) el.textContent = count;
                })
                .catch(error => console.error('Error loading announcements count:', error));
        }
        
        // Update sidebar counts on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSidebarCounts();
        });
        
        // Auto-refresh dashboard counts every 30 seconds
        setInterval(function() {
            if (document.getElementById('dashboard-section').style.display !== 'none') {
                console.log('?? Auto-refreshing dashboard counts...');
                loadDashboardData();
            }
            // Also update sidebar counts
            updateSidebarCounts();
        }, 30000);
        
        // Notification System
        let notifications = [];
        let unreadCount = 0;
        
        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const overlay = document.getElementById('notification-overlay');
            
            panel.classList.toggle('active');
            overlay.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                loadNotifications();
            }
        }
        
        async function loadNotifications() {
            console.log('🔔 Loading notifications...');
            const userRole = '{{user.role}}';
            
            try {
                let response;
                
                // Load notifications based on user role
                if (userRole === 'farmer') {
                    response = await fetch('/api/farmer/notifications?limit=20');
                } else if (userRole === 'staff' || userRole === 'admin') {
                    response = await fetch('/api/notifications/history?limit=20');
                } else {
                    // Fallback to sample notifications
                    showSampleNotifications();
                    return;
                }
                
                if (!response.ok) {
                    console.error('Failed to load notifications:', response.status);
                    showSampleNotifications();
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.notifications && data.notifications.length > 0) {
                    // Convert database notifications to display format
                    notifications = data.notifications.map(notif => ({
                        id: notif.id,
                        type: notif.notificationType || 'info',
                        title: notif.subject,
                        message: notif.message,
                        read: false, // TODO: Track read status per user
                        createdAt: new Date(notif.createdAt)
                    }));
                    
                    console.log(`✅ Loaded ${notifications.length} real notifications`);
                    console.log('📋 Notifications data:', notifications);
                    displayNotifications();
                    updateNotificationBadge();
                } else {
                    console.log('ℹ️ No notifications found');
                    console.log('📦 Response data:', data);
                    notifications = [];
                    displayNotifications();
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('❌ Error loading notifications:', error);
                showSampleNotifications();
            }
        }
        
        function displayNotifications() {
            const container = document.getElementById('notification-list');
            
            console.log('🎨 Displaying notifications, count:', notifications.length);
            console.log('📍 Container element:', container);
            
            if (!container) {
                console.error('❌ Notification container not found!');
                return;
            }
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>No new notifications</p>
                    </div>
                `;
                return;
            }
            
            const html = notifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'unread'} type-${notif.type}" onclick="markAsRead('${notif.id}')">
                    <div class="notification-meta">
                        <div class="notification-type">
                            <i class="fas ${getNotificationIcon(notif.type)}"></i>
                            ${notif.type.charAt(0).toUpperCase() + notif.type.slice(1)}
                        </div>
                        <div class="notification-time">${formatTime(notif.createdAt)}</div>
                    </div>
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-message">${notif.message}</div>
                </div>
            `).join('');
            
            console.log('✅ Setting notification HTML, length:', html.length);
            container.innerHTML = html;
        }
        
        function showSampleNotifications() {
            notifications = [
                {
                    id: '1',
                    type: 'announcement',
                    title: 'New Agricultural Program',
                    message: 'A new seed distribution program is now available for registered farmers.',
                    read: false,
                    createdAt: new Date(Date.now() - 1000 * 60 * 30)
                },
                {
                    id: '2',
                    type: 'alert',
                    title: 'Weather Alert',
                    message: 'Heavy rainfall expected in the next 48 hours. Secure your crops.',
                    read: false,
                    createdAt: new Date(Date.now() - 1000 * 60 * 60 * 2)
                },
                {
                    id: '3',
                    type: 'info',
                    title: 'System Update',
                    message: 'The system has been updated with new features.',
                    read: true,
                    createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24)
                }
            ];
            displayNotifications();
            updateNotificationBadge();
        }
        
        function getNotificationIcon(type) {
            const icons = {
                announcement: 'fa-bullhorn',
                alert: 'fa-exclamation-triangle',
                urgent: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            return icons[type] || 'fa-bell';
        }
        
        function formatTime(date) {
            const now = new Date();
            const diff = now - new Date(date);
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
        
        function markAsRead(notificationId) {
            const notif = notifications.find(n => n.id === notificationId);
            if (notif && !notif.read) {
                notif.read = true;
                displayNotifications();
                updateNotificationBadge();
            }
        }
        
        function updateNotificationBadge() {
            unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-count');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Load notification count on page load (without opening panel)
        async function checkNotificationCount() {
            const userRole = '{{user.role}}';
            
            try {
                let response;
                
                if (userRole === 'farmer') {
                    response = await fetch('/api/farmer/notifications?limit=20');
                } else if (userRole === 'staff' || userRole === 'admin') {
                    response = await fetch('/api/notifications/history?limit=20');
                } else {
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.notifications) {
                        // Update badge count
                        const count = data.notifications.length;
                        const badge = document.getElementById('notification-count');
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking notification count:', error);
            }
        }
        
        // Check notification count on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkNotificationCount();
        });
        
        // Auto-refresh notification count every 60 seconds
        setInterval(checkNotificationCount, 60000);

        // Make functions globally accessible
        window.loadDashboardData = loadDashboardData;
        window.updateSidebarCounts = updateSidebarCounts;
        window.toggleNotifications = toggleNotifications;
        window.checkNotificationCount = checkNotificationCount;
    </script>
</body>
</html>
